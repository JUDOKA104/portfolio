---
import Base from "../layouts/Base.astro";
import ProjectCard from "../components/ProjectCard";
import projects from "../data/projects.json";

const base = import.meta.env.BASE_URL ?? "/";

// Collecte des tags uniques (pour filtres)
const allTags = Array.from(new Set(projects.flatMap((p) => p.tags || []))).sort((a,b)=>a.localeCompare(b));

// JSON‑LD pour SEO (liste de projets)
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  itemListElement: projects.map((p, i) => ({
    "@type": "ListItem",
    position: i + 1,
    item: {
      "@type": "CreativeWork",
      name: p.title,
      description: p.description,
      url: p.repo || base + "projects",
      about: (p.tags || []).join(", ")
    }
  }))
};
---

<Base title="Projets — Enzo Oriol" description="Sélection de projets (sécurité Linux, PKI, portails, PDF/QWeb, perfs).">
  <script type="application/ld+json">{JSON.stringify(jsonLd)}</script>

  <header class="mb-5">
    <h2 class="text-3xl font-bold" style="
        margin-top: 20px;
    ">Projets</h2>
    <p class="text-[var(--muted)] mt-1">Sélection d'expériences techniques : sécurité Linux, PKI interne, portails et PDF/QWeb, gameplay & outils de perf.</p>
  </header>

  <!-- Contrôles -->
  <section class="asus-rog-card p-4 mb-5">
    <div class="grid gap-3 md:grid-cols-[1fr_auto_auto] items-center">
      <label class="block">
        <span class="sr-only">Rechercher</span>
        <input id="search" type="search" placeholder="Rechercher par titre, tag…" class="w-full rounded-xl border border-white/10 bg-white/5 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-white/20" />
      </label>
      <div class="flex items-center gap-2">
        <label class="text-sm text-[var(--muted)]" for="sort">Trier</label>
        <select id="sort" class="rounded-xl border border-white/10 bg-white/5 px-3 py-2">
          <option value="default">Par défaut</option>
          <option value="alpha">Alphabétique</option>
          <option value="repo">Avec dépôt d'abord</option>
          <option value="highlights">+ de points forts</option>
        </select>
      </div>
      <div class="flex items-center gap-2 justify-end">
        <button id="viewGrid" class="rounded-xl border border-white/10 bg-white/5 px-3 py-2" aria-pressed="true">Grille</button>
        <button id="viewList" class="rounded-xl border border-white/10 bg-white/5 px-3 py-2" aria-pressed="false">Liste</button>
      </div>
    </div>

    <!-- Tags -->
    <div class="mt-3 flex flex-wrap gap-2" id="tags">
      {allTags.map((t) => (
        <button data-tag={t} class="tag-pill inline-flex items-center rounded-full border border-white/10 bg-white/5 px-3 py-1 text-sm" aria-pressed="false">{t}</button>
      ))}
    </div>

    <div id="status" class="mt-3 text-sm text-[var(--muted)]">{projects.length} projets</div>
  </section>

  <!-- Grille / Liste -->
  <div id="projectsGrid" class="grid md:grid-cols-2 gap-5 auto-rows-fr items-stretch">
    {projects.map((p, idx) => (
      <div
        class="project-wrap h-full"
        data-idx={idx}
        data-title={(p.title || "").toLowerCase()}
        data-tags={(p.tags || []).join(",").toLowerCase()}
        data-hasrepo={Boolean(p.repo)}
        data-highlights={(p.highlights || []).length}
        >
        <ProjectCard {...p} />
      </div>
    ))}
  </div>

  <template id="emptyState">
    <div class="rounded-2xl border border-white/10 bg-white/5 p-8 text-center">
      <p class="text-[var(--muted)]">Aucun projet ne correspond à ces filtres.</p>
      <p class="text-[var(--muted)]">Essayez d'élargir la recherche ou de retirer certains tags.</p>
    </div>
  </template>

  <script type="module" client:load>
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

    const search = $('#search');
    const sort = $('#sort');
    const tags = $('#tags');
    const grid = $('#projectsGrid');
    const status = $('#status');
    const viewGrid = $('#viewGrid');
    const viewList = $('#viewList');
    const tplEmpty = $('#emptyState');

    const state = { q: '', tags: new Set(), sort: 'default', view: 'grid' };

    // A11Y for toggle buttons
    function setPressed(el, pressed) { el.setAttribute('aria-pressed', String(pressed)); }

    function apply() {
      const items = $$('.project-wrap', grid);
      let visible = [];

      // Filter
      for (const it of items) {
        const title = it.dataset.title || '';
        const tags = it.dataset.tags || '';
        const qOk = !state.q || title.includes(state.q) || tags.includes(state.q);
        const tagsOk = state.tags.size === 0 || Array.from(state.tags).every(t => tags.includes(t));
        const show = qOk && tagsOk;
        it.style.display = show ? '' : 'none';
        if (show) visible.push(it);
      }

      // Sort
      const collator = new Intl.Collator(undefined, { sensitivity: 'base' });
      visible.sort((a,b) => {
        switch(state.sort){
          case 'alpha':
            return collator.compare(a.dataset.title, b.dataset.title);
          case 'repo':
            return (b.dataset.hasrepo === 'true') - (a.dataset.hasrepo === 'true');
          case 'highlights':
            return Number(b.dataset.highlights||0) - Number(a.dataset.highlights||0);
          default:
            return Number(a.dataset.idx) - Number(b.dataset.idx);
        }
      });

      // Reflow
      visible.forEach(el => grid.appendChild(el));

      // View mode
      grid.className = state.view === 'grid' ? 'grid md:grid-cols-2 gap-5' : 'grid grid-cols-1 gap-3';
      setPressed(viewGrid, state.view === 'grid');
      setPressed(viewList, state.view === 'list');

      // Empty state
      const existingEmpty = $('.empty-state');
      if (existingEmpty) existingEmpty.remove();
      if (visible.length === 0) {
        const node = tplEmpty.content.cloneNode(true);
        const wrap = document.createElement('div');
        wrap.className = 'empty-state';
        wrap.appendChild(node);
        grid.parentElement.insertBefore(wrap, grid.nextSibling);
      }

      // Status
      status.textContent = `${visible.length} projet${visible.length>1?'s':''}`;
    }

    // Search
    search?.addEventListener('input', (e) => { state.q = e.target.value.trim().toLowerCase(); apply(); });

    // Sort
    sort?.addEventListener('change', (e) => { state.sort = e.target.value; apply(); });

    // Tags toggle
    tags?.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-tag]');
      if(!btn) return;
      const tag = (btn.dataset.tag || '').toLowerCase();
      if(state.tags.has(tag)) { state.tags.delete(tag); btn.classList.remove('ring-2','ring-white/30'); btn.setAttribute('aria-pressed','false'); }
      else { state.tags.add(tag); btn.classList.add('ring-2','ring-white/30'); btn.setAttribute('aria-pressed','true'); }
      apply();
    });

    // View mode
    viewGrid?.addEventListener('click', () => { state.view = 'grid'; apply(); });
    viewList?.addEventListener('click', () => { state.view = 'list'; apply(); });

    // Boot
    apply();
  </script>
</Base>
